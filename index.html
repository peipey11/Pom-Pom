<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Login</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-image: url("Gunduhomescreen.jpg");
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        margin: 0;
        backdrop-filter: brightness(0.9);
      }

      h2 {
        margin-bottom: 20px;
        color: #fff;
        text-shadow: 0 0 4px rgba(0, 0, 0, 0.6);
      }

      #usernameSection {
        margin-top: 25px;
        background: rgba(255, 255, 255, 0.95);
        padding: 20px 25px;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      label {
        display: block;
        margin-bottom: 8px;
        color: #333;
        font-weight: bold;
      }

      input[type="text"] {
        padding: 10px;
        width: 100%;
        max-width: 250px;
        font-size: 14px;
        border: 1px solid #ccc;
        border-radius: 6px;
        margin-bottom: 12px;
      }

      #submitUsername {
        padding: 10px 16px;
        font-size: 14px;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }

      #submitUsername:hover {
        background-color: #218838;
      }

      .gsi-material-button {
        margin-top: auto;
        margin-bottom: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 10px 20px;
        background: white;
        border: none;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        cursor: pointer;
        font-family: Roboto, sans-serif;
        width: 240px;
      }

      .gsi-material-button:hover {
        background-color: #eee;
      }

      .gsi-material-button-content-wrapper {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
      }

      .gsi-material-button-icon {
        margin-right: 10px;
        width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .gsi-material-button-contents {
        font-weight: bold;
        color: #444;
        font-size: 14px;
        display: inline-block;
      }
    </style>
  </head>

  <body>
    <h2></h2>

    <!-- Container for positioning both elements -->
    <div
      style="
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
        z-index: 10;
      "
    >
      <!-- Username Section (Initially Hidden) -->
      <div
        id="usernameSection"
        style="
          display: none;
          background: rgba(255, 255, 255, 0.8);
          border: 1px solid black;
          border-radius: 10px;
          padding: 20px;
          text-align: center;
          backdrop-filter: blur(8px);
          -webkit-backdrop-filter: blur(8px);
          box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        "
      >
        <label
          for="username"
          style="
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: black;
            background-color: transparent;
          "
        >
          Choose a unique username:
        </label>

        <input
          type="text"
          id="username"
          placeholder="e.g. coolgamer123"
          style="
            padding: 10px;
            width: 80%;
            max-width: 300px;
            border: 1px solid black;
            border-radius: 5px;
            margin-bottom: 15px;
            background-color: rgba(255, 255, 255, 0.8);
            color: black;
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
          "
        />
        <br />

        <button
          id="submitUsername"
          style="
            padding: 10px 20px;
            border: 1px solid black;
            border-radius: 5px;
            background-color: rgba(255, 255, 255, 0.8);
            color: black;
            cursor: pointer;
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
          "
        >
          Submit
        </button>
      </div>

      <!-- Google Sign-In Button -->
      <button
        class="gsi-material-button"
        id="google-login"
        style="
          cursor: pointer;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          border: none;
          border-radius: 10px;
          padding: 10px 20px;
          background: rgba(255, 255, 255, 0.8);
          backdrop-filter: blur(10px);
          -webkit-backdrop-filter: blur(10px);
          border: 2px solid black;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        "
      >
        <div
          class="gsi-material-button-content-wrapper"
          style="display: flex; align-items: center; gap: 10px"
        >
          <div
            class="gsi-material-button-icon"
            style="width: 24px; height: 24px"
          >
            <svg
              version="1.1"
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 48 48"
              style="display: block"
            >
              <path
                fill="#EA4335"
                d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"
              ></path>
              <path
                fill="#4285F4"
                d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"
              ></path>
              <path
                fill="#FBBC05"
                d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"
              ></path>
              <path
                fill="#34A853"
                d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"
              ></path>
              <path fill="none" d="M0 0h48v48H0z"></path>
            </svg>
          </div>
          <span
            class="gsi-material-button-contents"
            style="font-size: 14px; font-weight: bold; color: black"
            >Sign in with Google</span
          >
          <span style="display: none">Sign in with Google</span>
        </div>
      </button>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <!-- Firebase config -->
    <script src="firebase.js"></script>

    <script>
      let signedInUser = null;

      document
        .getElementById("google-login")
        .addEventListener("click", async () => {
          const provider = new firebase.auth.GoogleAuthProvider();

          try {
            const result = await firebase.auth().signInWithPopup(provider);
            signedInUser = result.user;

            const userDoc = await db
              .collection("users")
              .doc(signedInUser.uid)
              .get();

            if (userDoc.exists && userDoc.data().username) {
              window.location.href = "home.html";
            } else {
              // Show username section
              document.getElementById("usernameSection").style.display =
                "block";

              // âœ… Hide Google login button
              document.getElementById("google-login").style.display = "none";
            }
          } catch (error) {
            console.error("Login error:", error);
            alert("Login failed. See console for details.");
          }
        });

      document
        .getElementById("submitUsername")
        .addEventListener("click", async () => {
          const username = document.getElementById("username").value.trim();

          if (!username) {
            alert("Username is required");
            return;
          }

          try {
            const existing = await db
              .collection("users")
              .where("username", "==", username)
              .get();

            if (!existing.empty) {
              alert("Username already taken. Try a different one.");
              return;
            }

            await db.collection("users").doc(signedInUser.uid).set({
              uid: signedInUser.uid,
              email: signedInUser.email,
              username: username,
              photoURL: signedInUser.photoURL,
            });

            window.location.href = "home.html";
          } catch (error) {
            console.error("Error saving username:", error);
            alert("Something went wrong. See console for details.");
          }
        });
    </script>
  </body>
</html>

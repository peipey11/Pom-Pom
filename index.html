<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Login</title>
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family: Arial, sans-serif;
        background-image: url("Gunduhomescreen.jpg");
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        background-attachment: fixed;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        margin: 0;
        position: relative;
        overflow: hidden;
      }

      body::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.1);
        z-index: 1;
      }

      @keyframes rotate {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .rotating-image {
        width: 300px;
        height: auto;
        position: absolute;
        animation: rotate 4s linear infinite;
        z-index: 2;
      }

      .bottom-left {
        bottom: 95px;
        left: 155px;
      }

      .bottom-right {
        bottom: 60px;
        right: 100px;
      }

      h2 {
        margin-bottom: 20px;
        color: #fff;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        z-index: 10;
        position: relative;
      }

      .container {
        position: fixed;
        bottom: 40px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        z-index: 10;
        width: 90%;
        max-width: 400px;
      }

      #usernameSection {
        display: none;
        background: rgba(255, 255, 255, 0.95);
        border: 2px solid rgba(0, 0, 0, 0.2);
        border-radius: 12px;
        padding: 25px;
        text-align: center;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        width: 100%;
        max-width: 350px;
      }

      #usernameSection label {
        display: block;
        margin-bottom: 12px;
        font-weight: bold;
        color: #333;
        font-size: 14px;
      }

      #usernameSection input {
        padding: 12px;
        width: 100%;
        max-width: 280px;
        border: 2px solid #ddd;
        border-radius: 8px;
        margin-bottom: 15px;
        background-color: #fff;
        color: #333;
        font-size: 14px;
        transition: border-color 0.2s ease;
      }

      #usernameSection input:focus {
        outline: none;
        border-color: #4285f4;
      }

      #submitUsername {
        padding: 12px 24px;
        border: 2px solid #28a745;
        border-radius: 8px;
        background-color: #28a745;
        color: white;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        transition: all 0.2s ease;
      }

      #submitUsername:hover {
        background-color: #218838;
        border-color: #218838;
        transform: translateY(-1px);
      }

      .google-signin-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 12px 24px;
        background: #fff;
        border: 2px solid rgba(0, 0, 0, 0.2);
        border-radius: 12px;
        cursor: pointer;
        font-family: "Roboto", Arial, sans-serif;
        font-size: 14px;
        font-weight: 500;
        color: #3c4043;
        text-decoration: none;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        transition: all 0.2s ease;
        min-width: 240px;
        position: relative;
      }

      .google-signin-button:hover {
        background-color: #f8f9fa;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
      }

      .google-signin-button:active {
        transform: translateY(0);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      .google-icon {
        width: 20px;
        height: 20px;
        margin-right: 12px;
        flex-shrink: 0;
      }

      .google-icon svg {
        width: 100%;
        height: 100%;
        display: block;
      }

      .button-text {
        white-space: nowrap;
        font-weight: 500;
      }

      /* Fallback for browsers that don't support backdrop-filter */
      @supports not (backdrop-filter: blur(10px)) {
        #usernameSection {
          background: rgba(255, 255, 255, 0.95);
        }

        .google-signin-button {
          background: rgba(255, 255, 255, 0.95);
        }
      }

      /* Mobile responsiveness */
      @media (max-width: 480px) {
        .container {
          width: 95%;
          bottom: 20px;
        }

        #usernameSection {
          padding: 20px 15px;
        }

        .google-signin-button {
          min-width: 200px;
          padding: 10px 20px;
        }

        .button-text {
          font-size: 13px;
        }

        .rotating-image {
          width: 60px;
        }

        .bottom-left {
          bottom: 10px;
          left: 10px;
        }

        .bottom-right {
          bottom: 10px;
          right: 10px;
        }
      }

      /* High contrast mode support */
      @media (prefers-contrast: high) {
        .google-signin-button {
          border: 3px solid #000;
        }

        #usernameSection {
          border: 3px solid #000;
        }
      }
    </style>
  </head>

  <body>
    <img src="ring.png" class="rotating-image bottom-left" alt="Left Gear" />
    <img src="ring.png" class="rotating-image bottom-right" alt="Right Gear" />

    <h2></h2>

    <div class="container">
      <!-- Username Section (Initially Hidden) -->
      <div id="usernameSection">
        <label for="username">Choose a unique username:</label>
        <input
          type="text"
          id="username"
          placeholder="e.g. coolgamer123"
          autocomplete="username"
        />
        <br />
        <button id="submitUsername" type="button">Submit</button>
      </div>

      <!-- Google Sign-In Button -->
      <button class="google-signin-button" id="google-login" type="button">
        <div class="google-icon">
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path
              fill="#4285F4"
              d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
            />
            <path
              fill="#34A853"
              d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
            />
            <path
              fill="#FBBC05"
              d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
            />
            <path
              fill="#EA4335"
              d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
            />
          </svg>
        </div>
        <span class="button-text">Sign in with Google</span>
      </button>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <!-- Firebase config -->
    <script src="firebase.js"></script>

    <script>
      let signedInUser = null;

      // Force fresh login every time - sign out any existing user
      firebase.auth().signOut();

      // Add loading state management
      function setLoading(isLoading) {
        const googleButton = document.getElementById("google-login");
        const submitButton = document.getElementById("submitUsername");

        if (isLoading) {
          googleButton.style.opacity = "0.7";
          googleButton.style.cursor = "wait";
          submitButton.style.opacity = "0.7";
          submitButton.style.cursor = "wait";
        } else {
          googleButton.style.opacity = "1";
          googleButton.style.cursor = "pointer";
          submitButton.style.opacity = "1";
          submitButton.style.cursor = "pointer";
        }

        googleButton.disabled = isLoading;
        submitButton.disabled = isLoading;
      }

      document
        .getElementById("google-login")
        .addEventListener("click", async (event) => {
          event.preventDefault();

          if (event.currentTarget.disabled) return;

          setLoading(true);

          const provider = new firebase.auth.GoogleAuthProvider();
          provider.addScope("email");
          provider.addScope("profile");

          try {
            const result = await firebase.auth().signInWithPopup(provider);
            signedInUser = result.user;

            if (!signedInUser) {
              throw new Error("No user data received");
            }

            const userDoc = await db
              .collection("users")
              .doc(signedInUser.uid)
              .get();

            if (userDoc.exists && userDoc.data().username) {
              window.location.href = "home.html";
            } else {
              // Show username section with animation
              const usernameSection =
                document.getElementById("usernameSection");
              const googleButton = document.getElementById("google-login");

              usernameSection.style.display = "block";
              usernameSection.style.opacity = "0";
              usernameSection.style.transform = "translateY(20px)";

              // Smooth transition
              setTimeout(() => {
                usernameSection.style.transition = "all 0.3s ease";
                usernameSection.style.opacity = "1";
                usernameSection.style.transform = "translateY(0)";
              }, 10);

              googleButton.style.display = "none";

              // Focus on username input
              setTimeout(() => {
                document.getElementById("username").focus();
              }, 300);
            }
          } catch (error) {
            console.error("Login error:", error);

            let errorMessage = "Login failed. Please try again.";
            if (error.code === "auth/popup-closed-by-user") {
              errorMessage = "Login was cancelled.";
            } else if (error.code === "auth/popup-blocked") {
              errorMessage =
                "Popup was blocked. Please allow popups and try again.";
            }

            alert(errorMessage);
          } finally {
            setLoading(false);
          }
        });

      document
        .getElementById("submitUsername")
        .addEventListener("click", async (event) => {
          event.preventDefault();

          if (event.currentTarget.disabled) return;

          const username = document.getElementById("username").value.trim();

          if (!username) {
            document.getElementById("username").focus();
            alert("Username is required");
            return;
          }

          if (username.length < 3) {
            document.getElementById("username").focus();
            alert("Username must be at least 3 characters long");
            return;
          }

          if (!/^[a-zA-Z0-9_]+$/.test(username)) {
            document.getElementById("username").focus();
            alert(
              "Username can only contain letters, numbers, and underscores"
            );
            return;
          }

          setLoading(true);

          try {
            const existing = await db
              .collection("users")
              .where("username", "==", username)
              .get();

            if (!existing.empty) {
              document.getElementById("username").focus();
              document.getElementById("username").select();
              alert("Username already taken. Please try a different one.");
              return;
            }

            await db.collection("users").doc(signedInUser.uid).set({
              uid: signedInUser.uid,
              email: signedInUser.email,
              username: username,
              photoURL: signedInUser.photoURL,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            });

            window.location.href = "home.html";
          } catch (error) {
            console.error("Error saving username:", error);
            alert("Something went wrong. Please try again.");
          } finally {
            setLoading(false);
          }
        });

      // Allow Enter key to submit username
      document
        .getElementById("username")
        .addEventListener("keypress", (event) => {
          if (event.key === "Enter") {
            document.getElementById("submitUsername").click();
          }
        });

      // Check if user is already logged in
      firebase.auth().onAuthStateChanged((user) => {
        if (user) {
          signedInUser = user;
          // Check if user has username - only redirect if they have completed setup
          db.collection("users")
            .doc(user.uid)
            .get()
            .then((doc) => {
              if (doc.exists && doc.data().username) {
                // User is fully set up, redirect to home
                window.location.href = "home.html";
              } else {
                // User is logged in but hasn't set username yet, show username section
                document.getElementById("usernameSection").style.display =
                  "block";
                document.getElementById("usernameSection").style.opacity = "0";
                document.getElementById("usernameSection").style.transform =
                  "translateY(20px)";

                setTimeout(() => {
                  document.getElementById("usernameSection").style.transition =
                    "all 0.3s ease";
                  document.getElementById("usernameSection").style.opacity =
                    "1";
                  document.getElementById("usernameSection").style.transform =
                    "translateY(0)";
                }, 10);

                document.getElementById("google-login").style.display = "none";

                setTimeout(() => {
                  document.getElementById("username").focus();
                }, 300);
              }
            })
            .catch((error) => {
              console.error("Error checking user status:", error);
              // On error, sign out the user to be safe
              firebase.auth().signOut();
            });
        }
      });
    </script>
  </body>
</html>

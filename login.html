<!DOCTYPE html>
<html>
  <head>
    <title>Login</title>
  </head>
  <body>
    <h2>Login Page</h2>
    <button id="google-login">Login with Google</button>

    <!-- Username input (hidden initially) -->
    <div id="usernameSection" style="display: none">
      <label for="username">Enter a unique username:</label>
      <input type="text" id="username" />
      <button id="submitUsername">Submit</button>
    </div>

    <!-- Firebase v8 SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <!-- Your config and firebase initialization -->
    <script src="firebase.js"></script>

    <script>
      let signedInUser = null;

      document
        .getElementById("google-login")
        .addEventListener("click", async () => {
          const provider = new firebase.auth.GoogleAuthProvider();

          try {
            const result = await firebase.auth().signInWithPopup(provider);
            signedInUser = result.user;

            const userDoc = await db
              .collection("users")
              .doc(signedInUser.uid)
              .get();

            if (userDoc.exists && userDoc.data().username) {
              // User already has a username, redirect to index
              console.log("User already registered. Redirecting...");
              window.location.href = "index.html";
            } else {
              // Show username input section
              document.getElementById("usernameSection").style.display =
                "block";
            }
          } catch (error) {
            console.error("Login error:", error);
            alert("Login failed. See console for details.");
          }
        });

      document
        .getElementById("submitUsername")
        .addEventListener("click", async () => {
          const username = document.getElementById("username").value.trim();

          if (!username) {
            alert("Username is required");
            return;
          }

          try {
            const existing = await db
              .collection("users")
              .where("username", "==", username)
              .get();

            if (!existing.empty) {
              alert("Username already taken. Try a different one.");
              return;
            }

            await db.collection("users").doc(signedInUser.uid).set({
              uid: signedInUser.uid,
              email: signedInUser.email,
              username: username,
              photoURL: signedInUser.photoURL,
            });

            console.log("Username saved successfully. Redirecting...");
            window.location.href = "index.html";
          } catch (error) {
            console.error("Error saving username:", error);
            alert("Something went wrong. See console for details.");
          }
        });
    </script>
  </body>
</html>
